{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowHouse Entry Form</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', Arial, sans-serif; }
        body { background: #f4f4f4; padding: 15px; }

        form { display: flex; flex-direction: column; gap: 12px; }
        label { font-size: 14px; font-weight: 600; color: #555; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        select:focus, input:focus { border-color: #4CAF50; outline: none; }
        button { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s ease; }
        button:hover { background: #2E8B57; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            padding-top: 50px;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 25px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .modal-body {
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
        }

        .modal-footer {
            text-align: right;
        }

        .modal-footer button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .modal-footer button.cancel {
            background-color: #e0e0e0;
            color: #333;
        }

        .modal-footer button.cancel:hover {
            background-color: #ccc;
        }

        .modal-footer button.confirm {
            background-color: #4CAF50;
            color: white;
        }

        .modal-footer button.confirm:hover {
            background-color: #388E3C;
        }

        .user-info {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            font-size: 14px;
            color: #333;
        }

        .user-info span {
            font-weight: bold; 
        }

        .logout-link {
            font-size: 14px;
            color: #333;
            background-color: #f0f0f0;
            text-decoration: none;
            padding: 8px 14px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            font-weight: normal;
            border: 1px solid #ccc;
        }

        .logout-link i {
            margin-right: 5px;
            font-size: 16px;
        }

        .logout-link:hover {
            background-color: #e0e0e0;
            border-color: #999;
        }

    </style>
</head>
<body>

    <h2>ShowHouse</h2>
    <div class="user-info">
        <span>Hi, {{ request.user.first_name }}</span>
        <a href="{% url 'user_entries_list' %}" style="margin-left: 80%; text-decoration: none;">
            <i class="fas fa-list" ></i> Entries
        </a>
        <a href="{% url 'logout' %}" style="text-decoration: none;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
    
    
    <form id="weekEntryForm" method="post">
        {% csrf_token %}
        
        <label for="bay">Bay:</label>
        <select id="bay" name="bay" required>
            <option value="">Select a Bay</option>
            {% for bay in bays %}
                <option value="{{ bay.id }}">{{ bay.name }}</option>
            {% endfor %}
        </select>

        <label for="bed_no">Bed:</label>
        <select id="bed_no" name="bed_no" required>
            <option value="">Select a Bed</option>
        </select>

        <label for="variety">Variety:</label>
        <select id="variety" name="variety" required>
            <option value="">Select a Variety</option>
        </select>
        
        <label for="amounts">Amounts:</label>
        <input type="number" id="amounts" name="amounts" required>
        
        <label for="date">Date (Week Number and Year):</label>
        <input type="text" id="date" name="date" required readonly>

        <input type="hidden" name="submitted_by" value="{{ request.user.id }}">

        <button type="button" id="submitBtn">Submit</button>
    </form>

    <script>
    
</script>
    <script>
        function getCurrentWeekAndYear() {
            const currentDate = new Date();


            const currentYear = currentDate.getFullYear();

            const startOfYear = new Date(currentYear, 0, 1);

            const dayOfWeek = startOfYear.getDay();
            const adjustDays = dayOfWeek <= 4 ? 1 - dayOfWeek : 8 - dayOfWeek;
            const firstThursday = new Date(currentYear, 0, 1 + adjustDays);

            const msDifference = currentDate - firstThursday;

            const weekNumber = Math.ceil(msDifference / (7 * 24 * 60 * 60 * 1000));
            const weekYear = weekNumber > 0 ? currentYear : currentYear - 1;

            return `Week ${weekNumber}, ${weekYear}`;
        }
        document.getElementById('date').value = getCurrentWeekAndYear();

        document.getElementById("submitBtn").addEventListener("click", function() {
            var formData = new FormData(document.getElementById("weekEntryForm"));

            fetch("{% url 'submit_week_entry' %}", {
                method: "POST",
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    window.location.href = "{% url 'week_form' %}"; // Redirect to table view
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => console.error("Error:", error));
        });

        $("#bay").change(function () {
            let bay_id = $(this).val();
            if (bay_id) {
                $.ajax({
                    url: "{% url 'get_beds' %}",
                    data: { 'bay_id': bay_id },
                    success: function (data) {
                        $("#bed_no").html('<option value="">Select a Bed</option>');
                        $.each(data.beds, function (key, value) {
                            $("#bed_no").append('<option value="' + value.id + '">' + value.code + '</option>');
                        });
                    }
                });
            } else {
                $("#bed_no").html('<option value="">Select a Bed</option>');
            }
        });

        $("#bed_no").change(function () {
            let bed_id = $(this).val();
            if (bed_id) {
                $.ajax({
                    url: "{% url 'get_varieties' %}",
                    data: { 'bed_id': bed_id },
                    success: function (data) {
                        $("#variety").html('<option value="">Select a Variety</option>');
                        $.each(data.varieties, function (key, value) {
                            $("#variety").append('<option value="' + value.id + '">' + value.name + '</option>');
                        });
                    }
                });
            } else {
                $("#variety").html('<option value="">Select a Variety</option>');
            }
        });

        $("#submitBtn").click(function () {
            $("#confirmationModal").fadeIn();
        });

        $(".cancel").click(function () {
            $("#confirmationModal").fadeOut();
        });

        $("#confirmSubmit").click(function () {
            $("#weekEntryForm").submit();
        });
    </script>

</body>
</html>
